app-id: net.damonlynch.rapid_photo_downloader
runtime: org.kde.Platform
runtime-version: 5.15-23.08
sdk: org.kde.Sdk
base: com.riverbankcomputing.PyQt.BaseApp
base-version: 5.15-23.08
cleanup-commands:
  # - /app/cleanup-BaseApp.sh
command: rapid-photo-downloader
finish-args:
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --socket=pulseaudio
  - --share=network
  - --device=all
  - --device=dri
  - --filesystem=host
  - --filesystem=xdg-download
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.kde.StatusNotifierWatcher
  - --talk-name=org.freedesktop.portal.FileChooser
  - --talk-name=com.canonical.AppMenu.Registrar
  - --talk-name=com.canonical.Unity
  - --talk-name=com.canonical.indicator.application
  - --talk-name=org.ayatana.indicator.application
  - --unset-env=XDG_DATA_HOME
  - --env=QT_PLUGIN_PATH=/app/lib64/plugins:/app/lib/plugins
  - --env=QTWEBENGINEPROCESS_PATH=/app/bin/QtWebEngineProcess
  - --env=PERL5LIB=/app/lib/perl5/site_perl/5.36.0/
  - --system-talk-name=org.freedesktop.UDisks2
  - --talk-name=org.freedesktop.DBus.Introspectable.*

modules:
  - shared-modules/intltool/intltool-0.51.json
  # enable inspection
  - gudev.json

  - python-pygobject.yaml

  - python-hatchling.yaml

  - python-hatchling-ext.yaml

  # runtime dep
  - python-arrow.yaml

  # runtime dep
  - name: python3-Babel
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "Babel" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/df/c4/1088865e0246d7ecf56d819a233ab2b72f7d6ab043965ef327d0731b5434/Babel-2.12.1-py3-none-any.whl
        sha256: b4246fb7677d3b98f501a39d43396d3cafdc8eadb045f4a31be01863f655c610
        x-checker-data:
          type: pypi
          name: Babel
          packagetype: bdist_wheel

  # runtime dep
  - name: python3-colour
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "colour>=0.1.5" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/74/46/e81907704ab203206769dee1385dc77e1407576ff8f50a0681d0a6b541be/colour-0.1.5-py2.py3-none-any.whl
        sha256: 33f6db9d564fadc16e59921a56999b79571160ce09916303d35346dddc17978c
        x-checker-data:
          type: pypi
          name: colour
          packagetype: bdist_wheel

  - python-gphoto2.yaml

  # runtime dep
  - name: python3-pillow
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "pillow" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/cd/74/ad3d526f3bf7b6d3f408b73fde271ec69dfac8b81341a318ce825f2b3812/pillow-10.4.0.tar.gz
        sha256: 166c1cd4d24309b30d61f79f4a9114b7b2313d7450912277855ff5dfd7cd4a06
        x-checker-data:
          type: pypi
          name: pillow
          packagetype: sdist

  # runtime dep
  - name: python3-psutil
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "psutil==6.0.0" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/18/c7/8c6872f7372eb6a6b2e4708b88419fb46b857f7a2e1892966b851cc79fc9/psutil-6.0.0.tar.gz
        sha256: 8faae4f310b6d969fa26ca0545338b21f73c6b15db7c4a8d934a5482faa818f2
        x-checker-data:
          type: pypi
          name: psutil
          packagetype: sdist

  # runtime dep
  - name: python3-pymediainfo
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "pymediainfo>=2.2.0" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/72/dc/549fc39fbeb6907dc2ef2fa96cad9eea39bac043f4ce56efe243c926480f/pymediainfo-6.0.1.tar.gz
        sha256: 96e04bac0dfcb726bed70c314b1219121c4b9344c66a98f426ce27d7f9abffb0
        x-checker-data:
          type: pypi
          name: pymediainfo
          packagetype: sdist

  # runtime dep
  - name: python3-pyxdg
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "pyxdg>=0.28" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/e5/8d/cf41b66a8110670e3ad03dab9b759704eeed07fa96e90fdc0357b2ba70e2/pyxdg-0.28-py2.py3-none-any.whl
        sha256: bdaf595999a0178ecea4052b7f4195569c1ff4d344567bccdc12dfdf02d545ab
        x-checker-data:
          type: pypi
          name: pyxdg
          packagetype: bdist_wheel

  - python-pyzmq.yaml

  # runtime dep
  - name: python3-show-in-file-manager
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "show-in-file-manager>=1.1.2" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/68/82/37f378b219d5700effecbf3b60316af3c770e6ea3de0a4c05feafa4c4317/show_in_file_manager-1.1.4-py3-none-any.whl
        sha256: ccfbf212866b70f94e6e8bc1d7acf6bf0ad4447ff7dca50e7a64573b59e1a2c9

  # runtime deps
  - name: python3-sortedcontainers
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "sortedcontainers" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/32/46/9cb0e58b2deb7f82b84065f37f3bffeb12413f947f9388e4cac22c4621ce/sortedcontainers-2.4.0-py2.py3-none-any.whl
        sha256: a163dcaede0f1c021485e957a39245190e74249897e2ae4b2aa38595db237ee0

  # runtime dep
  - name: python3-tenacity
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "tenacity" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/b6/cb/b86984bed139586d01532a587464b5805f12e397594f19f931c4c2fbfa61/tenacity-9.0.0-py3-none-any.whl
        sha256: 93de0c98785b27fcf659856aa9f54bfbd399e29969b0621bc7f762bd441b4539

  # runtime dep
  - name: python3-tornado
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "tornado" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/48/64/679260ca0c3742e2236c693dc6c34fb8b153c14c21d2aa2077c5a01924d6/tornado-6.3.3.tar.gz
        sha256: e7d8db41c0181c80d76c982aacc442c0783a2c54d6400fe028954201a2e032fe

  # runtime depency to notify
  # Traceback (most recent call last):
  #   File "/app/bin/rapid-photo-downloader", line 5, in <module>
  #     from raphodo.rapid import main
  #   File "/app/lib/python3.11/site-packages/raphodo/rapid.py", line 39, in <module>
  #     gi.require_version("Notify", "0.7")
  #   File "/app/lib/python3.11/site-packages/gi/__init__.py", line 122, in require_version
  #     raise ValueError('Namespace %s not available' % namespace)
  # ValueError: Namespace Notify not available

  - name: libnotify
    buildsystem: meson
    config-opts:
      - -Dman=false
      - -Dtests=false
      - -Dgtk_doc=false
      - -Ddocbook_docs=disabled
    sources:
      - type: archive
        url: https://download.gnome.org/sources/libnotify/0.8/libnotify-0.8.3.tar.xz
        sha256: ee8f3ef946156ad3406fdf45feedbdcd932dbd211ab4f16f75eba4f36fb2f6c0
        x-checker-data:
          project-id: 13149
          type: anitya
          url-template: https://download.gnome.org/sources/libnotify/$major.$minor/libnotify-$version.tar.xz

  # following dependencies are for exif images and metadata
  - python-gexiv2.yaml

  # stuck because of missing UDisks-2.0.typelib gir binding in kde runtime
  - udisk.yaml

  - exiftool.yaml

  - name: libzen
    buildsystem: simple
    build-commands:
      - cd Project/CMake && cmake -DCMAKE_INSTALL_PREFIX=/app -DCMAKE_INSTALL_LIBDIR=lib -DCMAKE_BUILD_TYPE=Release
      - cd Project/CMake && make
      - cd Project/CMake && make install
    sources:
      - type: git
        url: https://github.com/MediaArea/ZenLib.git
        tag: v0.4.39

  - name: libmediainfo
    subdir: Project/CMake
    buildsystem: simple
    build-commands:
      - cmake -DCMAKE_INSTALL_PREFIX=/app -DCMAKE_INSTALL_LIBDIR=lib -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=On
      - make
      - make install
    sources:
      - type: git
        url: https://github.com/MediaArea/MediaInfoLib.git
        tag: v21.03

  - name: rapid-photo-downloader
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} . --no-build-isolation
    sources:
      - type: git
        url: https://github.com/damonlynch/rapid-photo-downloader
        tag: v0.9.37a5
        commit: 0790ca2f771da819d32ea2e9cae979bac9d0f490
# flatpak-builder flatpakbuild net.damonlynch.rapid_photo_downloader.yaml --install-deps-from=flathub --force-clean
# flatpak-builder --user --install flatpakbuild net.damonlynch.rapid_photo_downloader.yaml
# flatpak run net.damonlynch.rapid_photo_downloader

# ERROR:root:pymediainfo is installed, but the library libmediainfo appears to be missing
# ERROR: pymediainfo is installed, but the library libmediainfo appears to be missing
